<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>patients</title>
    <link rel="stylesheet" href="../layui/css/layui.css" media="all">
    <style>
        body {
            margin: 3px;
        }
        
        .demo-carousel {
            height: 200px;
            line-height: 200px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- js src~~ -->
    <script src="../layui/layui.js"></script>

    <!-- tinymce editer -->
    <script src='../tinymce/tinymce.min.js'></script>
    <script>
        tinymce.init({
            selector: '#ReportArea',
            // inline: true,
            height: 700,
            // plugins: "fullpage",
            // menubar: "file",
            // toolbar: "fullpage",
            fullpage_default_encoding: "UTF-8",
            plugins: [
                'advlist autolink lists link image charmap print preview anchor',
                'searchreplace visualblocks code fullscreen',
                'insertdatetime media table paste code help wordcount',
                'autosave'
            ],
            toolbar: 'undo redo | formatselect | ' +
                ' bold italic backcolor | alignleft aligncenter ' +
                ' alignright alignjustify | bullist numlist outdent indent |' +
                ' removeformat | help',
            menubar: 'edit view insert format tools table tc help',
            autosave_restore_when_empty: true,
            autosave_interval: "10s",
            init_instance_callback: function(editor) {
                // editor.notificationManager.open({
                //     text: '这是一条提示信息。',
                // });
            }
        });
        var tinyID = 'ReportArea';
        var initContent = 'frist';
        // 获得内容
        function getContent() {
            initContent = tinyMCE.editors[tinyID].getContent();
            layer.alert(initContent);
        };
        // 设置内容
        function setContent() {
            tinyMCE.editors[tinyID].setContent(initContent);
        };

        function saveContent() {
            // tinyMCE.editors[tinyID].getContent(initContent);
        };
    </script>
    <!-- tinymce editer -->

    <script>
        function SetFormValue(jsonstring) {
            var data = JSON.parse(jsonstring);
            //layer.alert(data);
            //给表单赋值
            layui.form.val("formpatient", {
                "PatientName": data.patientName,
                "PatientSex": data.patientSex,
                "PatientBirthday": data.patientBirthday,
                "PatientTelNumber": data.patientTelNumber,
                "PatientEmail": data.patientEmail,
                "PatientCarID": data.patientCarID,
                "PatientAddr": data.patientAddr,
                "StudyCost": data.studyCost,
                "StudyDepart": data.studyDepart,
                "StudyModality": data.studyModality,
                "ScheduledDate": data.scheduledDateTime,
                "CostType": data.costType,
                "StudyDescription": data.studyDescription,
                "PatientID": data.patientId,
                "PatientIdentity": data.patientIdentity,
                "StudyOrderIdentity": data.studyOrderIdentity
            });

        };

        function ClearFormValue() {
            //layer.alert(data);
            //给表单赋值
            layui.form.val("formpatient", {
                "PatientName": "",
                "PatientSex": "",
                "PatientBirthday": "",
                "PatientTelNumber": "",
                "PatientEmail": "",
                "PatientCarID": "",
                "PatientAddr": "",
                "StudyCost": "",
                "StudyDepart": "",
                "StudyModality": "",
                "ScheduledDate": "",
                "CostType": "",
                "StudyDescription": "",
                "PatientID": "",
                "PatientIdentity": "",
                "StudyOrderIdentity": ""
            });

        };

        function ChangeTab(table, item) {
            ClearFormValue(); // don't submit data ,to do ....
            layui.element.tabChange(table, item);
        }
    </script>
    <script>
        layui.use('laydate', function() {
            var laydate = layui.laydate; //执行一个laydate实例
            laydate.render({
                elem: '#stduystart', //指定元素
                format: 'yyyyMMdd',
                calendar: true
            });
            laydate.render({
                elem: '#stduyend', //指定元素
                format: 'yyyyMMdd',
                calendar: true
            });
            laydate.render({
                elem: '#birthdate', //指定元素
                format: 'yyyyMMdd',
                calendar: true
            });
            laydate.render({
                elem: '#ScheduledDate', //指定元素
                format: 'yyyyMMdd',
                calendar: true
            });
        });
    </script>

    <div class="layui-tab layui-tab-brief" lay-filter="TabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this" lay-id='layid_patients'>Patients</li>
            <li lay-id='layid_addedit'>Add/Edit</li>
            <li lay-id='layid_tool'>Report</li>
            <li lay-id='layid_image'>StudyImage</li>
            <li lay-id='layid_updown'>Updown</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <!-- patients datas table start -->
                <table class="layui-hide" id="studytable" lay-filter="studytabledatas"></table>
                <div class="layui-inline">
                    DateFrom:
                </div>
                <div class="layui-inline">
                    <input type="text" class="layui-input" id="stduystart" placeholder="yyyyMMdd">
                </div>
                <div class="layui-inline">
                    DateEnd:
                </div>
                <div class="layui-inline">
                    <input type="text" class="layui-input" id="stduyend" placeholder="yyyyMMdd">
                </div>
                <div class="layui-inline"> PatientType: </div>
                <div class="layui-inline">
                    <select name="StudyRoom" lay-filter="ptype">
                            <option value="10">Depart Room </option>
                            <optgroup label="RIS">
                                <option value="10">普放科</option>
                                <option value="11">核医学</option>
                            </optgroup>
                            <optgroup label="US">
                                <option value="20">心脏科</option>
                                <option value="21">彩超科</option>
                            </optgroup>
                            <optgroup label="ES">
                                <option value="30">肠镜科</option>
                                <option value="31">胃镜科</option>
                            </optgroup>
                        </select>
                </div>
                <div class="layui-inline">
                    <div class="SerarchTable">
                        search:
                        <div class="layui-inline">
                            <input class="layui-input" name="searchitem" id="searchReload" autocomplete="off">
                        </div>
                        <button class="layui-btn" data-type="reload">search</button>
                    </div>
                </div>
            </div>
            <!------------------- end patients datas table --------------------------------------------- -->

            <!-- $$$$$$$$$$$$$$$$$$$$$$$$  form  add / edit patients datas start $$$$$$$$$$$$$$$$$$$$$$$$$$-->
            <div class="layui-tab-item">
                <form class="layui-form layui-form-pane1" action="" lay-filter="formpatient">
                    <div class="layui-form-item">
                        <label class="layui-form-label">PatientName:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientName" lay-verify="required|title" lay-reqText="PatientName不能为空" required placeholder="name" autocomplete="off" class="layui-input">
                        </div>
                        <label class="layui-form-label">PatientID:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientID" placeholder="System Value" class="layui-input" readonly="readonly">
                        </div>
                        <label class="layui-form-label">PatientIdentity:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientIdentity" placeholder="System Value" class="layui-input" readonly="readonly">
                        </div>
                        <label class="layui-form-label">StudyOrderIdentity:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="StudyOrderIdentity" placeholder="System Value" class="layui-input" readonly="readonly">
                        </div>
                    </div>
                    <div class="layui-form-item" pane>
                        <label class="layui-form-label">PatientSex:</label>
                        <div class="layui-input-block">
                            <input type="radio" name="PatientSex" value="M" title="男" checked>
                            <input type="radio" name="PatientSex" value="F" title="女">
                            <input type="radio" name="PatientSex" value="O" title="其他" disabled>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">PatientBirth:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientBirthday" id="birthdate" lay-verify="datetime" placeholder="yyyyMMdd" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">phoneNumber:</label>
                        <div class="layui-input-inline">
                            <input type="tel" name="PatientTelNumber" lay-verify="required|number" lay-verType="tips" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">Email:</label>
                        <div class="layui-input-inline">
                            <input type="email" name="PatientEmail" lay-verify="email" lay-verType="alert" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">PatientCarID:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="PatientCarID" lay-verify="required|title" lay-reqText="PatientCarID标题不能为空" required placeholder="CarID" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">PatientAddr:</label>
                        <div class="layui-input-block">
                            <input type="text" name="PatientAddr" lay-verify="required|title" lay-reqText="PatientAddr不能为空" required placeholder="PatientAddr" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">Cost:</label>
                            <div class="layui-input-inline" style="width: 100px;">
                                <input type="text" name="StudyCost" placeholder="￥" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">StudyRoom:</label>
                            <div class="layui-input-block">
                                <select name="StudyDepart" lay-filter="contents">
                                        <option value="">SelectDepartments </option>
                                        <optgroup label="RIS">
                                          <option value="10">普放科</option>
                                          <option value="11">核医学</option>
                                        </optgroup>
                                        <optgroup label="US">
                                          <option value="20">心脏科</option>
                                          <option value="21">彩超科</option>
                                        </optgroup>
                                        <optgroup label="ES">
                                          <option value="30">肠镜科</option>
                                          <option value="31">胃镜科</option>
                                        </optgroup>
                                      </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">StudyModality:</label>
                            <div class="layui-input-block">
                                <select name="StudyModality" lay-verify="required" lay-verType="tips">
                                    <option value="">Select study modality</option>
                                    <option value="CT">CT</option>
                                    <option value="MR">MR</option>
                                    <option value="DR">DR</option>
                                    <option value="CR">CR</option>
                                    <option value="RF">RF</option>
                                    <option value="DX">DX</option>
                                    <option value="PET">PET</option>
                                    <option value="US">US</option>
                                    <option value="ES">ES</option>
                                  </select>
                            </div>
                        </div>

                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">ScheduledDate:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="ScheduledDate" id="ScheduledDate" lay-verify="datetime" placeholder="yyyyMMdd" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">CostType</label>
                        <div class="layui-input-inline">
                            <select name="CostType" lay-filter="interest">
                                  <option value=""></option>
                                  <option value="自费">自费</option>
                                  <option value="公费">公费</option>
                                  <option value="半公费">半公费</option>
                                  <option value="其它">其它</option>
                                </select>
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">请填写检查描述</label>
                        <div class="layui-input-block">
                            <textarea placeholder="检查描述" class="layui-textarea" name="StudyDescription"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="patientform">立即提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            <button class="layui-btn" onclick="ChangeTab('TabBrief', 'layid_patients')">
                            return patients
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <!-- $$$$$$$$$$$$$$$$$$$$$$$$$$$$$ end form $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$----- -->
            <div class="layui-tab-item ">
                <input type="button" class="layui-btn layui-btn-sm" onclick="getContent()" value="获得内容">
                <input type="button" class="layui-btn layui-btn-sm" onclick="setContent()" value="设置内容">
                <input type="button" class="layui-btn layui-btn-sm" onclick="saveContent()" value="保存内容">
                <!-- <form method="post"> -->
                <textarea id="ReportArea"></textarea>
                <!-- </form> -->
            </div>
            <div class="layui-tab-item ">StudyImage to do next...</div>
            <div class="layui-tab-item ">
                upload file to server
                <div class="layui-inline ">
                    <input type="text " class="layui-input " id="uploadDemo ">
                </div>
            </div>
        </div>
        <div class="layui-tab-content "></div>
    </div>
    <script>
        layui.use(['laypage', 'table', 'element', 'upload', 'form'], function() {
            var laypage = layui.laypage, //分页
                table = layui.table, //表格
                element = layui.element, //元素操作
                form = layui.form, //表单
                upload = layui.upload; //上传
            layer.msg('show patients study datas');

            //监听Tab切换
            element.on('tab(TabBrief)', function(data) {
                // layer.tips('切换了 ' + data.index + '：' + this.innerHTML, this, {
                //     tips: 1
                // });
            });
            // var myDate = new Date();
            // var mytime = myDate.toLocaleTimeString();
            // layer.msg('mytime:' + mytime);
            //执行一个 table 实例
            var tableObj = table.render({
                elem: '#studytable',
                height: 'full-200',
                url: window.location.host + '/healthsystem/ris/stduydata/?start=20190101&end=20191219', //数据接口 http://127.0.0.1:80/
                //url: 'http://127.0.0.1/healthsystem/ris/stduydata/?start=20190101&end=20191219',
                title: 'patients',
                page: true, //开启分页
                toolbar: 'default', //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
                totalRow: true, //开启合计行
                loading: true,
                //skin: 'row' ,
                limits: [20, 40, 60, 80, 100, 150, 200, 300],
                limit: 20,
                patientId: "testReload",
                size: 'sm',
                even: true, //开启隔行背景
                cols: [
                    [ //表头
                        {
                            type: 'checkbox',
                            fixed: 'left'
                        }, {
                            field: 'patientId',
                            title: 'PatientId',
                            width: 100,
                            sort: true,
                            fixed: 'left',
                            totalRowText: '合计：'
                        }, {
                            field: 'patientName',
                            width: 120,
                            title: 'PatientName'
                        }, {
                            field: 'studyDate',
                            title: 'StudyDateTime',
                            sort: true,
                            totalRow: false
                        }, {
                            field: 'patientSex',
                            title: 'PatientSex',
                            width: 100,
                            sort: false
                        }, {
                            field: 'studyModality',
                            title: 'StudyModality',
                            width: 100
                        }, {
                            field: 'studyId',
                            title: 'StudyId',
                            width: 120,
                            sort: true,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientBirthday',
                            title: 'PatientBirthday',
                            sort: true
                        }, {
                            field: 'studyDescription',
                            title: 'StudyDescription'
                        }, {
                            field: 'scheduledDateTime',
                            title: 'ScheduledDateTime',
                            sort: true,
                            totalRow: false
                        }, {
                            field: 'studyuid',
                            title: 'Studyuid',
                            sort: true,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'studystate',
                            title: 'Studystate',
                            sort: true,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientIdentity',
                            title: 'PatientIdentity',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'studyOrderIdentity',
                            title: 'StudyOrderIdentity',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientAddr',
                            title: 'PatientAddr',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientEmail',
                            title: 'PatientEmail',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientCarID',
                            title: 'PatientCarID',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'patientTelNumber',
                            title: 'TelNumber',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'studyDepart',
                            title: 'StudyDepart',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            field: 'studyCost',
                            title: 'StudyCost',
                            sort: false,
                            hide: true,
                            totalRow: true
                        }, {
                            field: 'costType',
                            title: 'CostType',
                            sort: false,
                            hide: true,
                            totalRow: false
                        }, {
                            fixed: 'right',
                            align: 'center',
                            toolbar: '#table_row_btns'
                        }
                    ]
                ]
            });
            var $ = layui.$,
                active = {
                    reload: function() {
                        var demoReload = $('#searchReload');
                        //执行重载
                        table.reload('testReload', {
                            page: {
                                curr: 1 //重新从第 1 页开始
                            },
                            where: {
                                key: {
                                    id: demoReload.val()
                                }
                            }
                        }, 'data');
                    }
                };

            $('.SerarchTable .layui-btn').on('click', function() {
                layer.msg('to do next...');
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });

            //监听头工具栏事件
            table.on('toolbar(studytabledatas)', function(obj) {
                var checkStatus = table.checkStatus(obj.config.id),
                    data = checkStatus.data; //获取选中的数据
                switch (obj.event) {
                    case 'add':
                        {
                            ClearFormValue();
                            element.tabChange('TabBrief', 'layid_addedit');
                            break;
                        }
                    case 'update':
                        if (data.length === 0) {
                            layer.msg('请选择一行');
                        } else if (data.length > 1) {
                            layer.msg('只能同时编辑一个');
                        } else {
                            // layer.alert('编辑 [id]：' + data[0].id);
                            //layer.alert('编辑 [id]：' + JSON.stringify(data[0]));
                            // element.tabChange('TabBrief', 'layid_addedit');
                            element.tabChange('TabBrief', 'layid_addedit');
                            SetFormValue(JSON.stringify(data[0]));
                        }
                        break;
                    case 'delete':
                        layer.msg('权限禁止删除！');
                        // if (data.length === 0) {
                        //     layer.msg('请选择一行');
                        // } else {
                        //     layer.msg('删除');
                        // }
                        break;
                };
            });

            //监听行工具事件 
            table.on('tool(studytabledatas)', function(obj) {
                var data = obj.data, //获得当前行数据
                    layEvent = obj.event; //获得 lay-event 对应的值
                if (layEvent === 'detail') {
                    //layer.msg('查看操作');
                    layer.alert('detail： rowIndex:' + obj.tr[0].rowIndex + ' 选中数据:' + JSON.stringify(obj.data));
                } else if (layEvent === 'del') {
                    layer.msg('权限禁止删除！');
                    // layer.confirm('真的删除行么', function(index) {
                    //     // obj.del(); //删除对应行（tr）的DOM结构
                    //     // layer.close(index);
                    //     //向服务端发送删除指令
                    // });
                } else if (layEvent === 'edit') {
                    element.tabChange('TabBrief', 'layid_addedit');
                    //layer.alert('rowDouble rowIndex:' + obj.tr[0].rowIndex + ' 选中数据:' + JSON.stringify(data));
                    SetFormValue(JSON.stringify(obj.data));
                    //layer.msg('编辑操作');
                }
            });
            //监听表格行点击
            // table.on('row(studytabledatas)', function(obj){
            //     console.log(obj)
            //     layer.alert('row rowIndex:'+ obj.tr[0].rowIndex +' 选中数据:'+JSON.stringify(obj.data));
            //  });
            //监听表格行双击
            table.on('rowDouble(studytabledatas)', function(obj) {
                // console.log(obj)
                layer.alert(obj.tr[0].rowIndex + ' 选中数据:' + JSON.stringify(obj.data));
            });
            //上传
            upload.render({
                elem: '#uploadDemo',
                url: '', //上传接口
                done: function(res) {
                    console.log(res);
                }
            });
            //submit patientform
            form.on('submit(patientform)', function(data) {
                var postdata = JSON.stringify(data.field);
                var host = window.location.host;
                $.ajax({
                    type: "POST",
                    url: host + '/healthsystem/ris/updata/',
                    async: false, //同步：意思是当有返回值以后才会进行后面的js程序。
                    data: postdata, //请求save处理数据
                    success: function(mess) {
                        if (mess == "OK") { //根据返回值进行跳转
                            // layer.alert(mess + '--save ok!' + postdata);
                            tableObj.reload(options); //重载表格
                            layer.msg('--save ok!--' + postdata);
                            ChangeTab('TabBrief', 'layid_addedit');
                            //table.render("studytabledatas");
                        } else {
                            layer.alert(mess + "--save fail:" + postdata);
                        }
                    }
                });
                return false;
            });
        });
    </script>

    <script type="text/html" id="table_row_btns">
        <a class="layui-btn layui-btn-primary layui-btn-xs " lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-xs " lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs " lay-event="del ">删除</a>
        <!-- 这里同样支持 laytpl 语法，如： -->
        {{# if(d.auth > 2){ }}
        <a class="layui-btn layui-btn-xs" lay-event="check">审核</a> {{# } }}
    </script>
</body>

</html>